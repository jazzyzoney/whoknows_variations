## Flask - Prometheus setup

In `requirements.txt` in the `src/backend` folder, the following packages have been added:

```txt
prometheus-client==0.13.1
psutil==5.8.0
```

Psutil is a cross-platform library for retrieving information on running processes and system utilization (CPU, memory, disks, network, sensors) in Python.

In `app.py` in the `src/backend` folder, all new sections have been clearly commented. Just search for `prometheus`. 

Here is the setup:

```python
CPU_GAUGE = Gauge(
    "whoknows_cpu_load_percent", "Current load of the CPU in percent."
)
REPONSE_COUNTER = Counter(
    "whoknows_http_responses_total", "The count of HTTP responses sent."
)
REQUEST_DURATION_SUMMARY = Histogram(
    "whoknows_request_duration_milliseconds", "Request duration distribution."
)


# Add /metrics route for Prometheus to pull metrics from
@app.route("/metrics")
def metrics():
    return Response(
        generate_latest(), mimetype="text/plain; version=0.0.4; charset=utf-8"
)
```

For every client HTTP request a counter is increased, the request duration is measured. 

```python
@app.before_request
def before_request():
    """Make sure we are connected to the database each request and look
    up the current user so that we know he's there.
    """
    # Prometheus metrics
    request.start_time = datetime.now()
    CPU_GAUGE.set(psutil.cpu_percent())
    # Prometheus metrics end
    g.db = connect_db()
    g.user = None
    if 'user_id' in session:
        g.user = query_db("SELECT * FROM users WHERE id = '%s'" % session['user_id'], one=True)


@app.after_request
def after_request(response):
    """Closes the database again at the end of the request."""
    g.db.close()
    # Prometheus metrics
    REPONSE_COUNTER.inc()
    t_elapsed_ms = (datetime.now() - request.start_time).total_seconds() * 1000
    REQUEST_DURATION_SUMMARY.observe(t_elapsed_ms)
    return response
```

Additionally, on every poll the CPU value is retrieved. 

The file `src/prometheus.yml` is a config file for Prometheus. It has been clearly commented to aid you. 


---

## docker-compose.yml

The docker-compose.yml should be pretty straightforward. 

The services are in the same network `app-network`. There is also an order in which they depend on each other. 

Port `3000` for Grafana and `9090` for Prometheus are the default ports. 

---

## Try it out

```bash
$ docker-compose up --build
```

Now go to http://localhost:8080/metrics. You can try refreshing a couple of times and see some of the metrics change (CPU usage, request counter).

This is the URL that Prometheus requests. How often it does this is defined in `src/prometheus.yml`.