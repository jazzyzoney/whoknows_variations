## The workflow file

## Overview

In [.github/workflows/continous_delivery.yml](../.github/workflows/continuous_delivery.yml) you will find the workflow that builds and pushes the images to the Github Container Registry.

The workflow file uses `buildx`. Buildx is a very powerful toolkit in testing and generating images for multiples architectures.

The smart thing is that you don't have to define the image names in the workflow file since it gets them from the `docker-compose.prod.yml` file.

## The workflow file

The workflow file does the following:

1. Checks out the repository. This way it has access to the files in the repository, including the `docker-compose.prod.yml` file.

2. Sets up `buildx` which, amongst many things, sets up the Docker daemon on the runner. 

3. Logs in to the Github Container Registry.

4. Builds and pushes the images. The crucial part is that the working directory and the file it uses should be correct.

This is correct for this repository but might not be the structure that you have:

```yaml
    - name: Build and Push Docker Images
      working-directory: ./src
      run: |
        docker buildx bake -f docker-compose.prod.yml --push
```

## Get started

1. Remember to set the secrets in the repository settings (assuming GH CLI is installed):

```bash
$ gh secret set CR_PAT
$ gh secret set DOCKER_GITHUB_USERNAME
```

Or run the setup script (in the root of this repository):

```bash
$ ./setup.sh
```

2. Change the two image names in `docker-compose.prod.yml` to your own.

For the first one, where it says:

```yaml
    image: ghcr.io/who-knows-inc/whoknows_variations_server:latest
```

Change this: `ghcr.io/<your_username_or_organisation>/<your_own_image_name>:latest` to your own.

3. **Note**, you might have to change the trigger. 

If you are using a different branch, perhaps in your own repository, then remember to change the trigger in the workflow file:

```yaml
on:
  push:
    branches: [ continuous_delivery ] # change me
  pull_request:
    branches: [ continuous_delivery ] # change me
```