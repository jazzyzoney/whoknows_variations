
## The tools

**Tflint** is a Terraform linter focused on possible errors, best practices, etc. It is a great tool to use to catch errors before running `terraform plan` or `terraform apply`.

**Checkov** is a static code analysis tool for infrastructure as code. It scans your IaC files and looks for security issues, compliance issues, and best practices.

**Tfsec** is a static analysis tool for Terraform code. It looks for security issues and best practices.

---

## The workflow

The workflow should be suprisingly readable. It installs and runs the 3 tools mentioned above and then finalizes by running `terraform validate`.

For the `tflint` and `checkov` steps the following key has been defined:

```yaml
    continue-on-error: true
```

It should be considered whether this is a good idea. The two tools will fail for the current setup for things that are intentional and desired. The compromise is to let them generate reports in the pipeline but not be blocking. 

The following are the different parts of the workflow files. 

---

### Setup

Checks out the code and installs Terraform:

```yaml
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 1.0.11
```

---

### The `tflint` step

Tflint is installed and run:

```yaml
    - name: Install TFLint
      run: |
        curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

    - name: Run TFLint
      run: tflint
      working-directory: infrastructure
```

---

### The `Checkov` step

Checkov is installed and run:

```yaml
    - name: Install Checkov
      run: pip install checkov

    - name: Run Checkov
      run: checkov -d .
      working-directory: infrastructure
      continue-on-error: true
```

**Note**: The `continue-on-error: true` is set to allow the pipeline to continue even if Checkov fails. This is because the current setup will fail for things that are intentional and desired. The same is true for `tfsec`.

See the type of warnings and errors it outputs [here](https://github.com/who-knows-inc/whoknows_variations/actions/runs/11000062066/job/30541638577) by clicking on `Run Checkov`.

One of the failures is that the VM allows all internet traffic to access it on port `80`. This is something that is desired so it is a false positive.

---

### The `tfsec` step

tfsec is installed and run:

```yaml
    - name: Install tfsec
      run: |
        curl -L "$(curl -s https://api.github.com/repos/aquasecurity/tfsec/releases/latest | jq -r '.assets[] | select(.name == "tfsec-linux-amd64") | .browser_download_url')" -o tfsec
        chmod +x tfsec
        sudo mv tfsec /usr/local/bin/

    - name: Run tfsec for static analysis
      run: tfsec
      working-directory: infrastructure
      continue-on-error: true
```

The first cURL line fetches a document that contains a URL for the latest release candidate of `tfsec`. It uses this URL to install from. 

See the type of warnings and errors it outputs [here](https://github.com/who-knows-inc/whoknows_variations/actions/runs/11000062066/job/30541638577) by clicking on `Run tfsec for static analysis`.

For instance, it warns that SSH is accessible from any IP address which is what I want it to be in my case but for a company it would be smart to restrict it to a specific IP range (office network) and require employees to VPN into the office network if they need to access the VM outside of the office.

---

### The `terraform validate` step

Finally, Terraform is initialized and validated. This is to ensure that the Terraform code is valid if the developer has forgotten to do the step locally.

```yaml
    - name: Terraform Init
      run: terraform init
      working-directory: infrastructure

    - name: Terraform Validate
      run: terraform validate
      working-directory: infrastructure
```
